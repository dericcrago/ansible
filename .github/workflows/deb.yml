---
name: deb
on:
  push:
    branches:
      - deb_build_action
env:
  DEB_DIST: bionic focal
  PBUILDER_BIN: sudo pbuilder
jobs:
  deb:
    name: build deb
    runs-on: ubuntu-20.04
    steps:
      - name: install requirements
        run: |
          sudo apt update
          sudo apt -y install --no-install-recommends \
              make \
              python3-packaging \
              python3-setuptools \
              python3-straight.plugin \
              python3-jinja2 \
              python3-yaml \
              python3-docutils \
              devscripts \
              build-essential:native \
              cdbs \
              dh-python \
              lsb-release \
              pbuilder
          sudo ln -sf python3 /usr/bin/python

      - name: checkout repo
        uses: actions/checkout@v2

      - name: checkout v2.10.5
        run: |
          git fetch --prune --tags
          git checkout tags/v2.10.5
          git clean -f -- .

      - name: build the v2.10.5 debs
        run: make clean && time make deb

      - name: upload v2.10.5 bionic debs
        uses: actions/upload-artifact@v2
        with:
          name: v2.10.5-bionic-debs
          path: deb-build/bionic/*.deb

      - name: upload v2.10.5 focal debs
        uses: actions/upload-artifact@v2
        with:
          name: v2.10.5-focal-debs
          path: deb-build/focal/*.deb

      - name: checkout devel
        run: |
          git checkout devel
          git clean -f -- .

      - name: build the devel debs
        run: make clean && time make deb

      - name: upload devel bionic debs
        uses: actions/upload-artifact@v2
        with:
          name: devel-bionic-debs
          path: deb-build/bionic/*.deb

      - name: upload devel focal debs
        uses: actions/upload-artifact@v2
        with:
          name: devel-focal-debs
          path: deb-build/focal/*.deb
